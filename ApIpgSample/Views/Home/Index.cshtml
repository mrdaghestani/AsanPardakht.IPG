@model CallbackViewModel
@{
    ViewData["Title"] = "AsanPardakht IPG Sample";
}
<br />
<div class="row">
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="col-lg-3 col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <span>خطا</span>
                </div>
                <div class="panel-body">
                    <p>
                        @Model.ErrorMessage
                    </p>
                </div>
            </div>
        </div>
    }
    @if (Model.TranResult != null)
    {
        <div class="col-lg-6 col-md-8">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <span>نتیجه تراکنش</span>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <h5 class="text-center">اطلاعات تراکنش اصلی</h5>
                            <table class="table table-bordered table-striped ltr">
                                <tr>
                                    <th>Amount:</th>
                                    <td>@Model.TranResult.Amount</td>
                                </tr>
                                <tr>
                                    <th>CardNumber:</th>
                                    <td>@Model.TranResult.CardNumber</td>
                                </tr>
                                <tr>
                                    <th>LocalInvoiceId:</th>
                                    <td>@Model.TranResult.LocalInvoiceId</td>
                                </tr>
                                <tr>
                                    <th>PayGateTranID:</th>
                                    <td>@Model.TranResult.PayGateTranID</td>
                                </tr>
                                <tr>
                                    <th>RefID:</th>
                                    <td>@Model.TranResult.RefID</td>
                                </tr>
                                <tr>
                                    <th>RRN:</th>
                                    <td>@Model.TranResult.RRN</td>
                                </tr>
                                <tr>
                                    <th>ServiceTypeId:</th>
                                    <td>@Model.TranResult.ServiceTypeId</td>
                                </tr>
                            </table>
                            <h5 class="text-center">اطلاعات ارائه سرویس</h5>
                            @if (Model.TranResult.ServiceType == AsanPardakht.IPG.Models.ServiceType.Buy)
                            {


                                <div class="alert alert-info">
                                    تراکنش خرید سرویس جانبی ندارد
                                </div>
                            }
                            else
                            {
                                <table class="table table-bordered table-striped ltr">
                                    <tr>
                                        <th>BillId:</th>
                                        <td>@Model.TranResult.BillId</td>
                                    </tr>
                                    <tr>
                                        <th>BillOrganizationNameFa:</th>
                                        <td>@Model.TranResult.BillOrganizationNameFa</td>
                                    </tr>
                                    <tr>
                                        <th>OperatorId:</th>
                                        <td>@Model.TranResult.OperatorId</td>
                                    </tr>
                                    <tr>
                                        <th>OperatorNameFa:</th>
                                        <td>@Model.TranResult.OperatorNameFa</td>
                                    </tr>
                                    <tr>
                                        <th>ProductId:</th>
                                        <td>@Model.TranResult.ProductId</td>
                                    </tr>
                                    <tr>
                                        <th>ProductNameFa:</th>
                                        <td>@Model.TranResult.ProductNameFa</td>
                                    </tr>
                                    <tr>
                                        <th>ProductPrice:</th>
                                        <td>@Model.TranResult.ProductPrice</td>
                                    </tr>
                                    <tr>
                                        <th>SimTypeId:</th>
                                        <td>@Model.TranResult.SimTypeId</td>
                                    </tr>
                                    <tr>
                                        <th>SimTypeTitleFa:</th>
                                        <td>@Model.TranResult.SimTypeTitleFa</td>
                                    </tr>
                                    <tr>
                                        <th>ServiceStatusCode:</th>
                                        <td>
                                            @Model.TranResult.ServiceStatusCode
                                            @if (Model.TranResult.IsSuccessServiceStatusCode)
                                            {
                                                <span class="label-success">
                                                    موفق
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="label-danger">
                                                    ناموفق
                                                </span>
                                            }
                                        </td>
                                    </tr>
                                </table>
                            }
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 message-plcs">
                            @if (Model.VerifyResult == null)
                            {
                                <div class="alert alert-info">
                                    این تراکنش به صورت اتوماتیک وریفای میگردد
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-success">
                                    تراکنش با موفقیت وریفای شد
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <a href="/Home/Settle" class="btn btn-success btn-block ajax-link" data-merchant-configuration-id="@(Model.TranResult.MerchantConfigurationId)" data-pay-gate-tran-id="@(Model.TranResult.PayGateTranID)">Settle Transaction</a>
                                    </div>
                                    <div class="col-xs-6">
                                        <a href="/Home/Reverse" class="btn btn-danger btn-block ajax-link" data-merchant-configuration-id="@(Model.TranResult.MerchantConfigurationId)" data-pay-gate-tran-id="@(Model.TranResult.PayGateTranID)">Reverse Transaction</a>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="col-lg-3 col-md-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span>پاسخ متد زمان سرور</span>
            </div>
            <div class="panel-body ltr">
                <span>@Model.Time</span>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span>پرداخت</span>
            </div>
            <div class="panel-body">
                <form asp-action="Pay">
                    <div class="form-group">
                        <label>مبلغ:</label>
                        <input type="text" class="form-control ltr" placeholder="مبلغ به ریال" name="Amount">
                    </div>
                    <div class="form-group">
                        <label>موبایل:</label>
                        <input type="text" class="form-control ltr" placeholder="شماره موبایل" name="Mobile">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">پرداخت</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span>خرید شارژ موبایل</span>
            </div>
            <div class="panel-body">
                <form asp-action="PayCharge">
                    <div class="form-group">
                        <label>موبایل شارژ شونده:</label>
                        <input type="text" class="form-control ltr" placeholder="شماره موبایل شارژ" name="DestinationMobile">
                    </div>
                    <div class="form-group">
                        <label>نوع شارژ:</label>
                        <select class="form-control">
                            <option data-telecom-operator-id="" data-product-id="" data-amount="">----</option>
                            <optgroup label="همراه اول">
                                <option data-telecom-operator-id="1" data-product-id="514" data-amount="10000">1,000 توماني</option>
                                <option data-telecom-operator-id="1" data-product-id="515" data-amount="20000">2,000 توماني</option>
                                <option data-telecom-operator-id="1" data-product-id="516" data-amount="50000">5,000 توماني</option>
                            </optgroup>
                            <optgroup label="ایرانسل">
                                <option data-telecom-operator-id="2" data-product-id="509" data-amount="10900">1,000 توماني</option>
                                <option data-telecom-operator-id="2" data-product-id="510" data-amount="21800">2,000 توماني</option>
                                <option data-telecom-operator-id="2" data-product-id="511" data-amount="54500">5,000 توماني</option>
                            </optgroup>
                            <optgroup label="رایتل">
                                <option data-telecom-operator-id="4" data-product-id="521" data-amount="20000">2,000 توماني</option>
                                <option data-telecom-operator-id="4" data-product-id="522" data-amount="50000">5,000 توماني</option>
                                <option data-telecom-operator-id="4" data-product-id="523" data-amount="100000">10,000 توماني</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>کد اپراتور:</label>
                        <input type="text" class="form-control ltr" placeholder="کد اپراتور" name="TelecomOperatorId">
                    </div>
                    <div class="form-group">
                        <label>کد شارژ:</label>
                        <input type="text" class="form-control ltr" placeholder="کد شارژ" name="ProductId">
                    </div>
                    <div class="form-group">
                        <label>مبلغ:</label>
                        <input type="text" class="form-control ltr" placeholder="مبلغ به ریال" name="Amount">
                    </div>
                    <div class="form-group">
                        <label>موبایل:</label>
                        <input type="text" class="form-control ltr" placeholder="شماره موبایل" name="Mobile">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">پرداخت</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span>خرید بسته</span>
            </div>
            <div class="panel-body">
                <form asp-action="PayBolton">
                    <div class="form-group">
                        <label>موبایل شارژ شونده:</label>
                        <input type="text" class="form-control ltr" placeholder="شماره موبایل شارژ" name="DestinationMobile">
                    </div>
                    <div class="form-group">
                        <label>نوع شارژ:</label>
                        <select class="form-control">
                            <option data-telecom-operator-id="" data-product-id="" data-amount="">----</option>
                            <optgroup label="ایرانسل - سیمکارت اعتباری">
                                <option data-telecom-operator-id="2" data-product-id="456" data-amount="17440" data-sim-type-id="1">شصت مگ 1,600ت</option>
                            </optgroup>
                            <optgroup label="همراه اول - سیمکارت اعتباری">
                                <option data-telecom-operator-id="1" data-product-id="1001027" data-amount="17440" data-sim-type-id="1">1 روزه  60مگ</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>نوع سیمکارت:</label>
                        <input type="text" class="form-control ltr" placeholder="نوع سیمکارت" name="SimTypeId">
                    </div>
                    <div class="form-group">
                        <label>کد اپراتور:</label>
                        <input type="text" class="form-control ltr" placeholder="کد اپراتور" name="TelecomOperatorId">
                    </div>
                    <div class="form-group">
                        <label>کد شارژ:</label>
                        <input type="text" class="form-control ltr" placeholder="کد شارژ" name="ProductId">
                    </div>
                    <div class="form-group">
                        <label>مبلغ:</label>
                        <input type="text" class="form-control ltr" placeholder="مبلغ به ریال" name="Amount">
                    </div>
                    <div class="form-group">
                        <label>موبایل:</label>
                        <input type="text" class="form-control ltr" placeholder="شماره موبایل" name="Mobile">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">پرداخت</button>
                </form>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script type="text/javascript">
        var page = {
            init: function () {
                $('select').each(function () {
                    var select = $(this);
                    var form = select.closest('form');
                    select.change(function () {
                        var selectedItem = $(this).find("option:selected");
                        var data = selectedItem.data();
                        for (var name in data) {
                            var inputName = name.replace(/\b[a-z]/g, function (letter) {
                                return letter.toUpperCase();
                            });
                            var input = form.find('input[type="text"][name="' + inputName + '"]');
                            var value = data[name];
                            input.val(value);
                            input.prop('readonly', value && true);
                        }
                    });
                });

                $('a.ajax-link').each(function () {
                    var link = $(this);
                    var msgPlcs = $('.message-plcs');
                    link.click(function (e) {
                        e.preventDefault();

                        var link = $(this);

                        if (link.data('loading'))
                            return;
                        link.data('loading', true);

                        var linkData = link.data();
                        var postData = {};
                        for (var name in linkData) {
                            var inputName = name.replace(/\b[a-z]/g, function (letter) {
                                return letter.toUpperCase();
                            });
                            postData[inputName] = linkData[name];
                        }

                        $.ajax({
                            url: link.attr('href'),
                            type: 'post',
                            data: JSON.stringify(postData),
                            contentType: 'application/json',
                            success: function (data) {

                                if (data.isSuccess) {
                                    msgPlcs.append($('<div />').addClass('alert alert-success').append(data.message));
                                } else if (data.error) {
                                    msgPlcs.append($('<div />').addClass('alert alert-danger').append(data.error));
                                } else {
                                    msgPlcs.append($('<div />').addClass('alert alert-danger').append('خطای نامشخص'));
                                }
                            },
                            error: function () {
                                console.log(arguments);
                                msgPlcs.append($('<div />').addClass('alert alert-danger').append('خطای نامشخص'));
                            },
                            complete: function () {
                                link.data('loading', false);
                            }
                        });
                    });
                });
            }
        };
        $(document).ready(page.init);
    </script>
}